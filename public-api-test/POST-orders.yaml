openapi: 3.0.0
servers:
  - url: 'https://dev.fa.com/vX/'
info:
  title: Create a new Order
  version: 0.0.1

paths:
  /orders:
    post:
      description: Create a new Order.
      tags:
        - orders
      security:
        - AuthToken: []
        - TenantToken: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - applicant
                - product
              properties:
                applicant:
                  $ref: '#/components/schemas/XYZApplicant'
                co_applicants:
                  type: array
                  items:
                    $ref: '#/components/schemas/XYZApplicant'
                institutions:
                  type: array
                  minimum: 1
                  items:
                    $ref: '#/components/schemas/XYZInstitution'
                requester:
                  $ref: '#/components/schemas/XYZRequestor'
                requirement:
                  $ref: '#/components/schemas/XYZRequirement'
                webhook:
                  type: string
                  description: A URL string. This URL will be notified during
                    certain stages of the order's lifecycle. Check the order
                    status documentation `orders/{id}/status` for details.
                product:
                  type: string
                skip_notification:
                  type: string
                  default: false
                  description: Bypasses the notification sent to applicants.
                days_to_process:
                  type: integer
                  description: Overrides the days to process setting from the tenant.
                  minimum: 30
                  maximum: 2555
      responses:
        default:
          $ref: '#/components/responses/AppError'
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/XYZOrder'
components:
  parameters:
    page:
      name: page
      in: query
      description: The requested page number.
      schema:
        type: integer
        default: 1
    requested:
      name: requested
      in: query
      description: The number of records to include in each page.
      schema:
        type: integer
        default: 25
        maximum: 500
    sort:
      name: sort
      in: query
      description: >-
        The field to sort by. May use commas to separate multiple fields.
        
        Prefix a field with - to indicate sort in descending order.
      schema:
        type: string
    filter:
      name: filter
      in: query
      description: >-
        The filter as a json object string. Prefix keys with 'x' to denote values as datetime rfc3339 strings.
      schema:
        type: string
        example: '{age: {$gt: 18}}'

  schemas:
    Login:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
        password:
          type: string
    XYZOrder:
      type: object
      properties:
        public_id:
          type: string
        consumer_id:
          type: string
        applicant:
          $ref: '#/components/schemas/XYZApplicant'
        co_applicants:
          type: array
          items:
            $ref: '#/components/schemas/XYZApplicant'
        institutions:
          type: array
          items:
            $ref: '#/components/schemas/XYZInstitution'
        product:
          type: object
          properties:
            code:
              type: string
            description:
              type: string
            flow_type:
              type: integer
            template_public_id:
              type: string
        requester:
          $ref: '#/components/schemas/XYZRequestor'
        requirement:
          $ref: '#/components/schemas/XYZRequirement'
        assignment:
          type: object
          properties:
            operator_id:
              type: string
            first_name:
              type: string
            last_name:
              type: string
        webook:
          type: string
        status:
          $ref: '#/components/schemas/XYZOrderStatus'
        tpr_id:
          type: string
        date:
          type: string
          format: date-time
        date_modified:
          type: string
          format: date-time
        options:
          type: object
          properties:
            days:
              type: integer
              description: Overrides the days to process setting on the tenant.
              minimum: 30
              maximum: 2555
            formats:
              type: array
              description: Allows order reports format to be limited. JSON will always be created. If empty it will generate all three.  Duplicates or unsupported formats will return error.
              items:
                type: string
                enum:
                  - json
                  - html
                  - pdf
                example:
                  - pdf
                  - html
            product:
              type: object
              properties:
                tobal:
                  type: object
                  properties:
                    amount:
                      type: number
                    operator:
                      type: string
                bal:
                  type: object
                  properties:
                    amount:
                      type: number
                    operator:
                      type: string
                nsfocc:
                  type: object
                  properties:
                    count:
                      type: integer
                    operator:
                      type: string
                gross_income:
                  type: object
                  properties:
                    range_percent:
                      type: number
                    gross_percent:
                      type: number
                    additional_income:
                      type: number
                low_balance:
                  type: object
                  properties:
                    balance_1:
                      type: number
                    balance_2:
                      type: number
                    balance_3:
                      type: number
                    balance_4:
                      type: number
                large_credit:
                  type: number
    XYZOrderStatus:
      type: integer
      description: |
        |  Status        |  Value  |         Description           |
        |---|---|---|
        |  Unknown       |  0      |  Unknown - The current status of this Order is Unknown. |          
        |  Received      |  1      |  Received - This Order has been Received.  |
        |  Pending       |  2      |  Pending - A notification has been sent to the borrower. Further action on this order is awaiting the borrower's response. | 
        |  AccountError  |  3      |  AccountError - An error occurred adding an account.    |
        |  Queued        |  4      |  Queued - This Order is queued for processing. This temporary state should be short-lived. |
        |  Processing    |  5      |  Processing - This Order is in process after an action has been taken by the borrower.   |
        |  Error         |  6      |  Error - An error occurred while processing this Order.   |
        |  Completed     |  7      |  Completed - The processing of this Order is complete.    |
        |  Canceled      |  8      |  Canceled  - This Order was Canceled before completion.  |
    XYZApplicant:
      type: object
      properties:
        first_name:
          type: string
        last_name:
          type: string
        middle_name:
          type: string
        ssn:
          type: string
        dob:
          type: string
        email:
          type: string
        mobile_phone:
          type: string
        work_phone:
          type: string
        home_phone:
          type: string
        address:
          type: string
        address2:
          type: string
        city:
          type: string
        state:
          type: string
        zip:
          type: string
        employer:
          $ref: '#/components/schemas/Employment'
        previous_employers:
          type: array
          items:
            $ref: '#/components/schemas/Employment'
        annual_income:
          type: number
        monthly_income:
          type: number
        weekly_income:
          type: number
        net_income:
          type: number
        marital_status:
          type: string
        dependents:
          type: number
    XYZRequestor:
      type: object
      properties:
        company_id:
          type: string
        company_name:
          type: string
        broker:
          type: string
        processor:
          type: string
        phone:
          type: string
        email:
          type: string
        reference_no:
          type: string
    Employment:
      type: object
      properties:
        name:
          type: string
        position:
          type: string
        length_months:
          type: number
        pay_cycle:
          type: string
        type:
          type: string
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        pay_amt_gross:
          type: number
          format: float
        pay_amt_net:
          type: number
          format: float
    Product:
      type: object
      properties:
        public_id:
          type: string
        code:
          type: string
        flow_type:
          type: integer
        description:
          type: string
        modules:
          type: array
          items:
            type: string
        template_public_id:
          type: string
        html_template:
          type: string
        email_template:
          type: string
        email_html_template:
          type: string
        email_subject_template:
          type: string
        sms_template:
          type: string
        date_modified:
          type: string
          format: date-time
    XYZInstitution:
      type: object
      properties:
        name:
          type: string
        public_id:
          type: string
        routing_no:
          type: string
        site_id:
          type: integer
        accounts:
          type: array
          items:
            type: object
            properties:
              public_id:
                type: string
              account_id:
                type: string
              account_type:
                type: string
              account_no:
                type: string
              name_on_account:
                type: string
              account_nickname:
                type: string
              account_address:
                type: string
              shared:
                type: boolean
    XYZRequirement:
      type: object
      properties:
        amt_to_close:
          type: number
          format: float
        amt_to_have:
          type: number
          format: float
        amt_to_have_days:
          type: integer
    MangoLoginFormField:
      type: object
      properties:
        display_name:
          type: string
        display_valid_values:
          type: array
          items:
            type: string
        field_type:
          type: string
        help_text:
          type: string
        is_editable:
          type: boolean
        is_escaped:
          type: boolean
        is_mfa:
          type: boolean
        is_optional:
          type: boolean
        is_optional_mfa:
          type: boolean
        max_length:
          type: integer
        name:
          type: string
        size:
          type: integer
        valid_values:
          type: array
          items:
            type: string
        value_identifier:
          type: string
        value_mask:
          type: string
        field_info_list:
          type: array
          items:
            type: object
            properties:
              fixed_multi_field:
                type: object
                properties:
                  default_values:
                    type: array
                    items:
                      type: string
                  values:
                    type: array
                    items:
                      type: string
                  valid_values:
                    type: array
                    items:
                      type: string
                  display_valid_values:
                    type: array
                    items:
                      type: string
                  value_identifiers:
                    type: array
                    items:
                      type: string
                  value_masks:
                    type: array
                    items:
                      type: string
                  field_types:
                    type: array
                    items:
                      type: object
                      properties:
                        type_name:
                          type: string
                  validation_rules:
                    type: array
                    items:
                      type: string
                  sizes:
                    type: array
                    items:
                      type: integer
                  maxlengths:
                    type: array
                    items:
                      type: integer
                  name:
                    type: string
                  display_name:
                    type: string
                  help_text:
                    type: string
                  is_editable:
                    type: boolean
                  is_escaped:
                    type: boolean
                  is_mfa:
                    type: boolean
                  is_optional:
                    type: boolean
                  is_optional_mfa:
                    type: boolean
              login_form_field:
                $ref: '#/components/schemas/MangoLoginFormField'
    AcctConsumerInstitution:
      type: object
      properties:
        _id:
          type: string
        account_id:
          type: string
        institution_id:
          type: integer
        institution_name:
          type: string
        status:
          $ref: '#/components/schemas/AcctConsumerInstitutionStatus'
        status_message:
          type: string
        last_refreshed:
          type: string
          format: date-time
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/AcctAccount'
      example:
        # TODO: update example
        - _id: 53e3a06eef3e55766b000002
          account_id: 10224035
          institution_name: 'BoS Site'
          status: 3
          status_message: Queued
          last_refreshed: '0001-01-01T00:00:00Z'
          accounts: null
    AcctConsumerInstitutionStatus:
      type: integer
      minimum: 0
      maximum: 15
      description: >-
        | Code     |  Status            | Description    |  Action Required       |
        |---|---|---|---|
        | 0        |  Unknown              |  An unknown error occurred.  | Try the process again. | 
        | 1        |  Ok                   |  The institution linked successfully with no errors.  | No further User action is required.  |
        | 2        |  Error                |  Request was canceled by the user or by the system.  | The User can try again immediately.  |
        | 3        |  Queued               |  The institution is waiting to be processed.  | No further User action is required.  |
        | 4        |  Refreshing           |  The institution is in the linking process.  | No further User action is required.  | 
        | 5        |  Processing           |  Requested data has been received. It is in process internally.  | No further User action is required.  |
        | 6        |  Login Failure        |  Unable to log in successfully to the User institution account. This may be due to an incorrect user name, password, or other security credential.  | The User should verify the credentials they provided, and try again.  |
        | 7        |  Internal System Error|  An internal error occurred.  | The User should try the process again.  | 
        | 8        |  Processing Error     |  An error occurred within the content services pipeline.  | The User should try the process again.  | 
        | 9        |  Institution Not Found Error|  Account error - no longer there, no longer supported, or not yet supported.  | The User should delete the institution.  | 
        | 10       |  Institution Account Error|  System error - system cannot access the account because there are actions or steps that must be completed by the User on their profile at the institution's site.  | The User must log into their site institution, perform some action related to their account before trying this process again.  |     
        | 11       |  Institution Site Error|  Institution site error - technical issues at the institution site, either unknown or due to maintenance windows.  | Generally, institution errors are resolved within a few hours or days. The User should try the process again after verifying that the institution site is again available.  |
        | 12       |  Communication Error   |  Connection and request communication issues.  | Generally temporary. The User should try the process again.  |
        | 13       |  Timeout Error         |  Timeout issues.  | The User should try the process again.  |
        | 14       |  PendingMFA            |  Waiting on additional multi-factor credentials from the end-user.  | The User must provide the requested information to continue.  |
        | 15       |  Not Refreshed         |  System message - the account cannot be refreshed within the no-refresh time period.  | The User must wait before trying the process again.  |                                                                          |
    AcctAccount:
      type: object
      properties:
        _id:
          type: string
        consumer_institution_id:
          type: string
        consumer_institution_name:
          type: string
        account_type:
          type: string
        account_name:
          type: string
        account_holder:
          type: string
        account_display_name:
          type: string
        history:
          type: array
          items:
            $ref: '#/components/schemas/AcctAccountHistory'
        details: {}
        institution:
          $ref: '#/components/schemas/AcctConsumerInstitution'
    AcctAccountHistory:
      type: object
      properties:
        account_name:
          type: string
        account_holder:
          type: string
        history_date:
          type: string
          format: date-time
        details: {}
  responses:
    AppError:
      description: Application error.
      content:
        application/json:
          schema:
            type: object
            properties:
              messages:
                type: array
                items:
                  type: string
            example:
              messages:
                - You are not authorized for this action
    ArrayOfConsumerErrors:
      description: Application Error
      content:
        application/json:
          schema:
            type: array
            items:
              type: object
              properties:
                consumer_id:
                  type: string
                message:
                  type: string
            example:
              - consumer_id: a031137a-4c4b-4b8e-5be5-3747a7953e83
                message: Consumer not eligible, no completed orders.
              - consumer_id: b2fbc913-c7c0-452a-5a10-09e4b34ab6a9
                message: Consumer not found.
              - consumer_id: b2fbc913-c7c0-452a-5a10-09e4b34ab6a9
                message: Application error.
              - consumer_id: c63fa6e8-0494-4ee1-5e96-c26fa31fc62a
                message: Consumer not processed.
              - consumer_id: b5d03e74-92c9-462f-455f-827a77b8082d
                message: Consumer not processed.
  requestBodies:
    Login:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Login'
    Product:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Product'
  securitySchemes:
    AppToken:
      description: application jwt
      type: apiKey
      name: X-App-Token
      in: header
    AuthToken:
      description: 'sysadmin, operator, consumer jwt'
      type: apiKey
      name: Authorization
      in: header
    TenantBasicAuth:
      description: 'base64encoded[public_id:access_key]'
      type: http
      scheme: basic
    TenantToken:
      description: tenant jwt
      type: apiKey
      name: X-Tenant-Token
      in: header